---
title: "Gut Content Analysis: Amundsen graphs"
author: "Jess Madden"
date: "2/19/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(here)
library(readxl)
library(janitor)
```

```{r}
gut_contents_all <- read.csv(here::here("data", "Diet_gutcontent_data.csv"))

#only interested in guts from R Beach, Refugio, and Percos

gut_contents <- gut_contents_all %>% 
  filter(site %in% c("Refugio", "Percos", "R Beach"))
```


###Amundsen plots

Frequency of occurence of prey i: %Fi = (Ni/N)*100
Prey specific abundance: %Pi = (sum(Si)/sum(Sti)*100)

```{r}
# Frequency of occurence by site

##### CHECK HERE THAT THERE ARE NO DUPLICATE GUT ITEMS
check_N_i <- gut_contents %>% 
  mutate(fish_id_id = paste(fish_id, id, sep = "_")) %>% 
  get_dupes(fish_id_id)


N_i <- gut_contents %>% 
  group_by(site) %>% 
  count(id) %>% 
  rename("N_i" = "n")

N_guts <- gut_contents %>% 
  group_by(site) %>% 
  summarize(n_distinct(fish_id))

#calculate %Fi

F_i <- N_i %>% 
  full_join(N_guts) %>% 
  rename("N_guts" = "n_distinct(fish_id)") %>% 
  mutate(F_i = ((N_i/N_guts)*100))
```

```{r}
# Prey-specific abundance

S_i <- gut_contents %>% 
  group_by(site, id) %>%
  summarise(S_i = sum(count))

#S_t_emerita

emerita_fish <- gut_contents %>% 
  filter(id == "Emerita analoga") %>% 
  select(fish_id) %>% 
  pull(fish_id) #vectorizes the list of fish guts that had emerita in them

S_t_emerita <- gut_contents %>%
  filter(fish_id %in% emerita_fish) %>% 
  group_by(site) %>%
  summarise(S_ti = sum(count))



#Calculate S_ti for each species

species_list <- unique(gut_contents$id)

S_ti <- data.frame()
for (spp in species_list){
  print(spp)
  fish <- gut_contents %>% filter(id == spp) %>% select(id, fish_id)
  sum_t <- gut_contents %>% filter(fish_id %in% fish$fish_id) %>% group_by(site) %>% summarise(S_ti = sum(count))
  dat <- sum_t %>% mutate(species = spp)
  S_ti <- rbind.data.frame(S_ti, dat)
}

#calculate %Pi

S_i <- S_i %>% 
  mutate(site_id = paste(site, id, sep = "_"))

S_ti <- S_ti %>% 
  mutate("site_id" = paste(site, species, sep = "_"))

P_i <- S_i %>% 
  full_join(S_ti) %>% 
  select(site, id, S_i, S_ti) %>% 
  mutate(P_i = ((S_i/S_ti)*100))
```

Plot emerita 

```{r}
emerita <- F_i %>% 
  full_join(P_i) %>% 
  filter(id == "Emerita analoga")
  
ggplot(emerita, aes(x = F_i, y = P_i)) +
  geom_point() +
  facet_wrap(~site) +
  theme_minimal() +
  scale_x_continuous(limits = c(0, 100)) +
  scale_y_continuous(limits = c(0, 100)) +
  coord_fixed(ratio = 1) +
  labs(x = "% Frequency of occurence", y = "% Prey-specific abundance")

```

Plot certain species

```{r}
amundsen <- F_i %>% 
  full_join(P_i) %>% 
  filter(id %in% c("Emerita analoga", "Blepharipoda occidentalis", "Donax gouldii", "Tivela stultornum", "Excirolana chiltoni", "Idotea resecata"))
  
ggplot(amundsen, aes(x = F_i, y = P_i, color=id)) +
  geom_point() +
  facet_wrap(~site) +
  theme_minimal() +
  scale_x_continuous(limits = c(0, 100)) +
  scale_y_continuous(limits = c(0, 100)) +
  coord_fixed(ratio = 1) +
  labs(x = "% Frequency of occurence", y = "% Prey-specific abundance")
```

### Amundsen plots: repeat analysis for adult vs juvenile fish by site


Frequency of occurrence of prey i: %Fi = (Ni/N)*100
Prey specific abundance: %Pi = (sum(Si)/sum(Sti)*100)

```{r}
# Frequency of occurrence by life stage

gut_contents_ls <- gut_contents %>% 
  filter(lifestage %in% c("Adult", "Juvenile")) #Removes fish with no sex recorded

##### CHECK HERE THAT THERE ARE NO DUPLICATE GUT ITEMS
check_N_i <- gut_contents_ls %>% 
  mutate(fish_id_id = paste(fish_id, id, sep = "_")) %>% 
  get_dupes(fish_id_id)


N_i_ls <- gut_contents_ls %>% 
  group_by(site, lifestage) %>% 
  count(id) %>% 
  rename("N_i_ls" = "n")

N_guts_ls <- gut_contents_ls %>% 
  group_by(site, lifestage) %>% 
  summarize(n_distinct(fish_id))

#calculate %Fi

F_i_ls <- N_i_ls %>% 
  full_join(N_guts_ls) %>% 
  rename("N_guts_ls" = "n_distinct(fish_id)") %>% 
  mutate(F_i_ls = ((N_i_ls/N_guts_ls)*100))
```

```{r}
# Prey-specific abundance

S_i_ls <- gut_contents_ls %>% 
  group_by(site, lifestage, id) %>%
  summarise(S_i_ls = sum(count)) %>% 
  mutate(lifestage_id = paste(site, lifestage, id, sep = "_"))

#Calculate S_ti for each species

species_list <- unique(gut_contents_ls$id)

S_ti_ls <- data.frame()
for (spp in species_list){
  print(spp)
  fish <- gut_contents_ls %>% filter(id == spp) %>% select(id, fish_id)
  sum_t <- gut_contents_ls %>% filter(fish_id %in% fish$fish_id) %>% group_by(site, lifestage) %>% summarise(S_ti_ls = sum(count))
  dat <- sum_t %>% mutate(id = spp) %>% mutate(lifestage_id = paste(site, lifestage, id, sep = "_"))
  S_ti_ls <- rbind.data.frame(S_ti_ls, dat)
}

#calculate %Pi

P_i_ls <- S_i_ls %>% 
  full_join(S_ti_ls) %>% 
  select(site, lifestage, id, S_i_ls, S_ti_ls) %>% 
  mutate(P_i_ls = ((S_i_ls/S_ti_ls)*100))
```


Amundsen plots by lifestage (dominant taxa)** needs refinement

```{r}
amundsen_ls <- F_i_ls %>% 
  full_join(P_i_ls) %>% 
  filter(id %in% c("Emerita analoga", "Blepharipoda occidentalis", "Donax gouldii", "Tivela stultornum", "Excirolana chiltoni", "Idotea resecata", "Mysid"))

gut_contents_ls$site <- as.factor(gut_contents_ls$site)
gut_contents_ls$lifestage <- as.factor(gut_contents_ls$lifestage)

sample_size_ls <- gut_contents_ls %>% 
  group_by(lifestage) %>% 
  summarise(sample_size = n())
  
ggplot(amundsen_ls, aes(x = F_i_ls, y = P_i_ls, color=id)) +
  geom_point() +
  facet_grid(lifestage ~ site) +
  theme_minimal() +
  scale_x_continuous(limits = c(0, 100)) +
  scale_y_continuous(limits = c(0, 100)) +
  coord_fixed(ratio = 1) +
  labs(x = "% Frequency of occurrence", y = "% Prey-specific abundance")
```


### Amundsen plots: repeat analysis by season and site


Frequency of occurrence of prey i: %Fi = (Ni/N)*100
Prey specific abundance: %Pi = (sum(Si)/sum(Sti)*100)

```{r}
# Frequency of occurrence by season

##### CHECK HERE THAT THERE ARE NO DUPLICATE GUT ITEMS
check_N_i <- gut_contents %>% 
  mutate(fish_id_id = paste(fish_id, id, sep = "_")) %>% 
  get_dupes(fish_id_id)


N_i_ss <- gut_contents %>% 
  group_by(site, season) %>% 
  count(id) %>% 
  rename("N_i_ss" = "n")

N_guts_ss <- gut_contents %>% 
  group_by(site, season) %>% 
  summarize(n_distinct(fish_id))

#calculate %Fi

F_i_ss <- N_i_ss %>% 
  full_join(N_guts_ss) %>% 
  rename("N_guts_ss" = "n_distinct(fish_id)") %>% 
  mutate(F_i_ss = ((N_i_ss/N_guts_ss)*100))
```

```{r}
# Prey-specific abundance

S_i_ss <- gut_contents %>% 
  group_by(site, season, id) %>%
  summarise(S_i_ss = sum(count)) %>% 
  mutate(full_id = paste(site, season, id, sep = "_"))

#Calculate S_ti for each species

species_list <- unique(gut_contents$id)

S_ti_ss <- data.frame()
for (spp in species_list){
  print(spp)
  fish <- gut_contents %>% filter(id == spp) %>% select(id, fish_id)
  sum_t <- gut_contents %>% filter(fish_id %in% fish$fish_id) %>% group_by(site, season) %>% summarise(S_ti_ss = sum(count))
  dat <- sum_t %>% mutate(id = spp) %>% mutate(full_id = paste(site, season, id, sep = "_"))
  S_ti_ss <- rbind.data.frame(S_ti_ss, dat)
}

#calculate %Pi

P_i_ss <- S_i_ss %>% 
  full_join(S_ti_ss) %>% 
  select(site, season, id, S_i_ss, S_ti_ss) %>% 
  mutate(P_i_ss = ((S_i_ss/S_ti_ss)*100))
```


Amundsen plots by season + site (dominant taxa** needs refinement)

```{r}
amundsen_ss <- F_i_ss %>% 
  full_join(P_i_ss) #%>% 
#  filter(id %in% c("Emerita analoga", "Blepharipoda occidentalis", "Donax gouldii", "Tivela stultornum", "Excirolana chiltoni", "Idotea resecata", "Mysid"))

gut_contents$site <- as.factor(gut_contents$site)
gut_contents$season <- as.factor(gut_contents$season)

sample_size_ss <- gut_contents %>% 
  group_by(season) %>% 
  summarise(sample_size = n())
  
ggplot(amundsen_ss, aes(x = F_i_ss, y = P_i_ss, color=id, label = id, shape = season)) +
  geom_point() +
  facet_wrap(~site) +
  theme_minimal() +
  scale_x_continuous(limits = c(0, 100)) +
  scale_y_continuous(limits = c(0, 100)) +
  coord_fixed(ratio = 1) +
  labs(x = "% Frequency of occurrence", y = "% Prey-specific abundance") +
  theme(legend.position = "bottom") +
  geom_text(check.overlap = TRUE)
```

 
###Amundsen plots: repeat analysis with prey taxa to family

Frequency of occurence of prey i: %Fi = (Ni/N)*100
Prey specific abundance: %Pi = (sum(Si)/sum(Sti)*100)

```{r}
# Frequency of occurence by site

##### CHECK HERE THAT THERE ARE NO DUPLICATE GUT ITEMS
check_N_i <- gut_contents %>% 
  mutate(fish_id_id = paste(fish_id, id, sep = "_")) %>% 
  get_dupes(fish_id_id)


N_i_fam <- gut_contents %>% 
  group_by(site) %>% 
  count(family) %>% 
  rename("N_i_fam" = "n")

N_guts_fam <- gut_contents %>% 
  group_by(site) %>% 
  summarize(n_distinct(fish_id))

#calculate %Fi

F_i_fam <- N_i_fam %>% 
  full_join(N_guts_fam) %>% 
  rename("N_guts_fam" = "n_distinct(fish_id)") %>% 
  mutate(F_i_fam = ((N_i_fam/N_guts_fam)*100))
```

```{r}
# Prey-specific abundance

S_i_fam <- gut_contents %>% 
  group_by(site, family, zone) %>%
  summarise(S_i_fam = sum(count))

#Calculate S_ti for each family

family_list <- unique(gut_contents$family)

S_ti_fam <- data.frame()
for (fam in family_list){
  print(fam)
  fish <- gut_contents %>% filter(family == fam) %>% select(family, zone, fish_id)
  sum_t <- gut_contents %>% filter(fish_id %in% fish$fish_id) %>% group_by(site) %>% summarise(S_ti_fam = sum(count))
  dat <- sum_t %>% mutate(family = fam)
  S_ti_fam <- rbind.data.frame(S_ti_fam, dat)
}

#calculate %Pi

S_i_fam <- S_i_fam %>% 
  mutate(site_fam = paste(site, family, sep = "_"))

S_ti_fam <- S_ti_fam %>% 
  mutate(site_fam = paste(site, family, sep = "_"))

P_i_fam <- S_i_fam %>% 
  full_join(S_ti_fam) %>% 
  select(site, family, zone, S_i_fam, S_ti_fam) %>% 
  mutate(P_i_fam = ((S_i_fam/S_ti_fam)*100))
```

Plot certain species

```{r}
amundsen_fam <- F_i_fam %>% 
  full_join(P_i_fam)
  
ggplot(amundsen_fam, aes(x = F_i_fam, y = P_i_fam, color=family, label=family)) +
  geom_point() +
  facet_wrap(~site) +
  theme_minimal() +
  scale_x_continuous(limits = c(0, 100)) +
  scale_y_continuous(limits = c(0, 100)) +
  coord_fixed(ratio = 1) +
  labs(x = "% Frequency of occurence", y = "% Prey-specific abundance") +
  scale_color_discrete(labels=c("Hippidae" ="Sand crab", "Anthomyiidae" = "Kelp fly", "Caprellidae" = "Caprellid", "Cirolanidae" = "Intertidal isopod", "Idoteidae" = "Subtidal isopod", "Lottidae" = "Limpet", "Mysidae" = "Mysid", "Sphaeromatidae" = "Intertidal isopod", "Stronylocentrotidae" = "Purple urchin", "Albuneidae" = "Sand crab", "Ancinidae" = "Intertidal isopod","Cancridae" = "Crab", "Dendrasteridae" = "Sand dollar", "Donacidae" = "Bean clam", "Membraniporidae" = "Bryozoan", "Talitridae" = "Beach hopper", "Veneridae" = "Pismo clam")) +
  geom_text(check.overlap = TRUE)
```



Prey available vs prey ingested

```{r}
prey_size_data <- read_xlsx(here("data", "Diet_gutcontent_size_data_raw.xlsx")) %>% 
  clean_names()

emerita_ingested <- prey_size_data %>% 
  filter(category == "Emerita analoga") %>% 
  filter(site %in% c("Percos", "Refugio", "R Beach")) %>% 
  mutate(site_code = case_when(
    site == "Percos" ~ 1, 
    site == "Refugio" ~ 2, 
    site == "R Beach" ~ 3
  )) %>% 
  mutate(fish_id = paste(site_code, date, fish_id, sep = "_")) %>% 
  left_join(barred, by="fish_id")

ggplot(emerita_ingested, aes(x = size_mm, fill=sl_mm, group =sl_mm)) +
  geom_histogram() +
  theme_minimal() +
  xlim(0, 25) +
  scale_fill_gradient(high = "cyan4", low = "grey") +
  xlab("Ingested sand crab size (mm)") +
  ylab("Count") +
  labs(fill="Barred surfperch standard length (mm)") +
  theme(legend.position = c(.8, .75))
  

ggplot(emerita_ingested, aes(x = sl_mm, fill=size_mm, group =size_mm)) +
  geom_histogram() +
  theme_minimal() +
  scale_fill_gradient(high = "cyan4", low = "grey") +
  xlab("Barred surfperch standard length (mm)") +
  ylab("Count") +
  labs(fill="Ingested sand crab size (mm)") +
  theme(legend.position = c(.3, .75))
```

```{r}
# repeat above plot but with emerita count not sizes!
```


```{r}
emerita_pop_data <- read_xlsx(here("data", "Diet_emerita_population_data_raw.xlsx")) %>% 
  clean_names() %>% 
  subset(select = -c(22:23)) %>%
  filter(taxa == "Emerita analoga") %>%   
  filter(site %in% c("Percos", "Refugio", "R Beach"))

emerita_pop_data$width_length_mm <- as.numeric(emerita_pop_data$width_length_mm)

ggplot(emerita_pop_data, aes(x = width_length_mm)) +
  geom_histogram(binwidth = 1) +
  theme_minimal() +
  xlim(0, 25)
```

```{r}
#2 sample t-test of all emerita data aggregated

ingested_sizes <- emerita_ingested %>% 
  pull(size_mm)

pop_sizes <- emerita_pop_data %>% 
  pull(width_length_mm)

emerita_ttest <- t.test(x = ingested_sizes, y = pop_sizes)
```

